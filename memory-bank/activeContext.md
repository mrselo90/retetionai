# Active Context

## Current Focus: Cosmetics RAG Reliability + Eval Quality
- **Status**: API-key-free internal auth path is live (`INTERNAL_SERVICE_SECRET`), Maruderm HU test products ingested (10 products, chunked), and products dashboard chunk-status false negatives fixed.
- **Next Step**: Improve multilingual (TR/EN/HU) eval quality with proper product scoping, stronger facts-first usage, and better grounding.

## Recent Accomplishments
- **Merchant API Key Removal (Active Paths)**:
  - Merchant API key auth removed from runtime auth middleware and admin UI flows
  - Internal service auth (`X-Internal-Secret`) added for worker/eval/debug routes
  - Shopify app keys remain (Shopify requirements only)
- **Maruderm Test Dataset Ingestion**:
  - 10 real products from `maruderm.hu` ingested into test merchant
  - scrape + enrich + embedding pipeline validated end-to-end (chunks created)
- **Products Dashboard RAG Status Fix**:
  - `chunks/batch` parse error no longer causes false `0 chunk`
  - UI shows unknown state instead of false `RAG not ready` when chunk-count fetch fails
- **Landing Page Responsive Cleanup**:
  - Mobile-first spacing rhythm tightened across sections (Hero→Stats, Features, How It Works, Social Proof, Pricing, FAQ, CTA, Footer)
  - Alignment inconsistencies fixed (card heights, section headers, mobile CTA/button layout, footer grid spacing)
- **Manual RAG Test UX (Dashboard / Test)**:
  - Advanced RAG tab now loads existing merchant products and chunk counts for direct selection
  - Supports search/filter and multi-select so manual RAG questions can be scoped to specific scraped products (avoids all-products ambiguity)
  - Auth middleware updated to prefer JWT/Shopify token over internal secret, preventing browser requests from failing on stray `X-Internal-Secret` headers
- **Products Page View Modes**:
  - Added Shopify-style `Grid / List` toggle to Products dashboard
  - List view is mobile-first (stacked rows on small screens, table-like columns on desktop) and preserves existing RAG status badges/actions
  - Added Shopify-like product index controls: search, status filter, sort, result count, and reset filters (shared across grid/list views)
  - Follow-up runtime fixes: moved `useDeferredValue` above conditional returns (React hook order) and fixed dashboard summary rich-text translation formatting for Polaris subtitle
  - Filter toolbar alignment refined: search/status/sort fields now share the same label/control rhythm and responsive grid alignment
  - Polaris migration (step 1): Products filter toolbar now uses Polaris `TextField` + `Select` controls, moving the page closer to Shopify-native form behavior
  - Polaris migration (step 2): Desktop list view now uses Polaris `IndexTable` while keeping mobile stacked rows for mobile-first usability
  - Products index (step 3): Added applied filter chips and bulk product actions (select visible/clear selection/re-scrape/generate embeddings) aligned with RAG operations workflow
  - Products index (step 4): Bulk actions now use batch endpoints (`scrape-batch`, `generate-embeddings-batch`) and saved views/tabs (local persisted presets) were added for Shopify-like workflow
- **Dashboard Polaris-first Standardization (step 1)**:
  - Replaced remaining ad-hoc icon tiles/row icon shells with Polaris `Box`-based surfaces to align visual tokens/backgrounds with Shopify Polaris
  - Preserved existing dashboard information architecture while reducing custom Tailwind visual primitives
- **Conversations Polaris Migration (step 1)**:
  - Desktop conversations list migrated to Polaris `IndexTable` (mobile-first stacked rows retained)
  - Empty state and row icon surfaces moved toward Polaris `Box` primitives; table columns localized via `Conversations.table.columns`
- **Conversations Polaris Migration (step 2)**:
  - Sentiment and status filters migrated from custom button rows to Polaris `Tabs` (two-tab-bar filter layout)
  - Mobile horizontal-scroll hacks removed in favor of Polaris tab disclosure behavior
- **Conversations Polaris Migration (step 3)**:
  - Mobile conversation rows refactored to Polaris layout primitives (`Box`, `InlineStack`, `BlockStack`, `Text`) to reduce Tailwind-specific row composition
  - Removed placeholder header spacer from Conversations page structure
- **Conversation Detail Polaris Migration (step 1)**:
  - Header, message history wrapper, reply composer, and stats cards refactored to Polaris-first primitives (`Card`, `Box`, `InlineGrid`, `InlineStack`, `BlockStack`, `TextField`, `Badge`)
  - Preserved functional behavior (reply send, status toggles, polling) while removing a large share of custom Tailwind layout shells
- **Product Detail Polaris Migration (step 1)**:
  - `/dashboard/products/[id]` refactored to Polaris-first layout for product info, bot instructions, scraped content, return-prevention fields, and metadata sections
  - Custom `input/textarea/card` Tailwind shells replaced with Polaris `Card`, `Box`, `BlockStack`, `InlineGrid`, `InlineStack`, `TextField`, and `Badge`
  - Existing local behavior preserved (save, re-scrape, generate embeddings, instruction warning toast)
- **Test Page Polaris Migration (step 1)**:
  - `Dashboard / Test` header and step indicator refactored to Polaris layout primitives (`Box`, `BlockStack`, `InlineGrid`, `InlineStack`) while preserving mobile-first behavior
  - Advanced section tabs migrated from custom button row to Polaris `Tabs`
  - Core test flows (order create / delivery trigger / chat / RAG test tools) preserved for further incremental migration
- **Settings Polaris Migration (step 1)**:
  - Header and loading skeleton surfaces moved to Polaris card/box primitives
  - Notification settings card migrated to Polaris-first (`Polaris Card`, `TextField`)
  - Bot Persona top controls migrated to Polaris controls (`TextField`, `ChoiceList`, `Checkbox`, `RangeSlider`) while preserving save flow and embedded `ShopifySaveBar`
  - Product scope / WhatsApp sender option blocks now use Polaris choice controls with helper summaries and banners
- **Settings Polaris Migration (step 2)**:
  - `Modules`, `Guardrails`, and `GDPR` sections migrated to Polaris-first outer containers/headers (`Polaris Card`, `Box`, `BlockStack`, `InlineStack`)
  - Existing business logic/actions preserved (add-on toggle dialog, guardrail CRUD actions, GDPR export/delete actions)
  - Inner list rows still partially custom/Tailwind and can be standardized further in later passes
- **Settings Polaris Migration (step 3)**:
  - Guardrail add/edit modal form inputs migrated from native inputs/selects/textarea to Polaris `TextField` + `Select`
  - Merchant-critical guardrail configuration workflow is now closer to Shopify/Polaris form behavior while keeping existing dialog logic intact
- **Settings Polaris Migration (step 4)**:
  - Guardrails system/custom list rows standardized further with Polaris layout primitives (`Box`, `BlockStack`, `InlineStack`, `Text`)
  - GDPR export/delete inner panels and links section moved to Polaris-style boxed surfaces while preserving existing actions
  - Custom UI buttons remain where tied to existing shared button variants/dialog patterns, but surrounding layout is now Polaris-first
- **Customers Polaris Migration (step 1)**:
  - Segment filter migrated from custom button row to Polaris `Tabs`
  - Desktop customer list now uses Polaris `IndexTable` (mobile stacked list retained for mobile-first usability)
  - Search + pagination behavior preserved while moving list page closer to Shopify index patterns
- **Customers Polaris Migration (step 2)**:
  - Customer detail page (`/dashboard/customers/[id]`) refactored heavily toward Polaris-first layout
  - Header, metric cards, and orders/conversations/feedback sections now use Polaris `Card`, `Box`, `BlockStack`, `InlineStack`, `InlineGrid`, `Badge`, and `Button`
  - Existing navigation/data loading behaviors preserved while replacing most custom shadcn card shells
- **Integrations Polaris Migration (step 1)**:
  - Integrations header/support banner and the two most visible list sections (`Discover integrations`, `Active integrations`) standardized further with Polaris cards/badges/buttons
  - Connection CTA buttons for Shopify/WhatsApp/CSV/manual rows now use Polaris button styles, improving Shopify-admin consistency
  - Modals remain mixed (custom dialog + inputs/buttons) and are planned for a later pass
- **Integrations Polaris Migration (step 2)**:
  - Shopify / CSV / Manual / WhatsApp modals now use Polaris form controls and action buttons (`TextField`, Polaris `Button`) while keeping existing dialog shell/logic
  - Merchant integration setup flows are more consistent with Shopify admin interaction patterns
- **Analytics Polaris Migration (step 1)**:
  - Analytics loading surfaces and header/date-range container moved toward Polaris-first card/layout primitives
  - Date range controls still use native date inputs (inside Polaris surfaces) to preserve behavior while improving visual consistency
- **Analytics Polaris Migration (step 2)**:
  - Key metric cards, ROI stat cards, and return-prevention summary stat cards migrated to Polaris-first cards/layout primitives
  - Return-prevention top-products summary card also moved to Polaris card/badge styling; chart sections remain for later refactor
- **Analytics Polaris Migration (step 3)**:
  - Remaining chart wrappers (DAU + message volume) and empty state card sections moved to Polaris-first card/box/layout primitives
  - Recharts charts themselves are unchanged; only surrounding presentation shells were standardized
- **Admin Polaris Migration (step 1)**:
  - `/admin` dashboard migrated to Polaris `Page/Layout/Card` structure with Polaris metric cards and placeholder activity panel
  - `/admin/merchants` migrated to Polaris page structure and desktop `IndexTable`-style listing with Polaris badges/buttons
  - `/admin/system` migrated to Polaris page/layout, error/loading states, and queue/infrastructure card shells (queue content logic preserved)
- **Polaris Consistency Cleanup (step 1)**:
  - `Settings` add-on rows/actions moved further toward Polaris controls (status badge + action buttons), and add-on/guardrail/GDPR confirm modal actions now use Polaris buttons
  - `Settings` GDPR delete confirmation modal content converted to Polaris `Box`/`BlockStack` surfaces with Polaris button actions
  - `Integrations` modal body surfaces (Shopify/CSV/Manual/WhatsApp) wrapped with Polaris spacing/box structure; CSV helper/file state messaging aligned with Polaris text/surface patterns
- **Products Responsive Overlap Fixes**:
  - Saved views row changed to responsive split layout with horizontal scrolling chips to prevent overlap with save action on narrower widths
  - Applied filter chips and bulk action toolbar updated for mobile/desktop wrapping behavior to avoid stacked collisions
  - Desktop products list status/action cells constrained (`max-width`, responsive action stack) to prevent badge/button overlap in `IndexTable`
- **Admin Polaris Migration (step 2 / polish)**:
  - `/admin/system` queue cards refactored further to Polaris layout primitives (`InlineStack`, `InlineGrid`, `Box`, `Text`) while preserving queue stats logic
  - Redis infrastructure panel moved from custom flex/typography blocks to Polaris-first layout structure
  - “Queue Management (Coming Soon)” notice converted to Polaris `Banner`
- **Admin Polaris Migration (step 3 / consistency pass)**:
  - `/admin/merchants` table row badges/actions improved with wrapping behavior to avoid cramped layouts in narrower widths
  - `/admin/merchants` gained a Polaris-style operational note below the table for action hierarchy/context clarity
  - `/admin` platform overview removed unused visual config and added a Polaris `Banner` note to reinforce operational/admin context
- **Web Deploy Sync (customer-facing + admin Polaris updates)**:
  - Server pulled and built latest web commits up to `57138ad`
  - Next.js production build completed successfully and generated all key dashboard/admin routes (`products`, `customers`, `conversations`, `settings`, `analytics`, `integrations`, admin pages)
  - PM2 `api`, `web`, and `workers` restarted and confirmed `online`
- **Runtime Crash Fix (React #31)**:
  - Fixed a production crash caused by passing `lucide-react` icon components into Polaris `Button` `icon` props (Polaris expected a different icon source type)
  - Removed incompatible `icon={...}` usage in `settings`, `admin/merchants`, and `admin/system` Polaris buttons
  - Deployed web update (commit `1157c73`) and verified successful Next.js build + PM2 `web` restart
- **Runtime Crash Fix (React #31, follow-up sweep)**:
  - Additional incompatible Polaris button icon props removed from `dashboard/customers/[id]`, `dashboard/integrations`, and internal `dashboard/test`
  - Full scan confirms no remaining `Polaris Button icon={...}` usages with React icon components in app pages/components
  - Deployed web update (commit `8039355`) and verified successful build + PM2 `web` restart
- **RAG Language Consistency Fix (facts-first deterministic)**:
  - Deterministic `product_facts` answers now skip direct mode when `detectedLanguage` does not match the user query language (except language-agnostic `volume`)
  - Prevents mixed-language answers (e.g., Turkish template labels + Hungarian usage/frequency content) and falls back to normal LLM response generation
  - API/workers restarted after deploying commit `f20fa71`
- **Web Deploy Sync (latest Polaris changes)**:
  - Latest web build deployed to server (`root@209.97.134.215`) and PM2 `web` process restarted successfully
  - `api`, `web`, and `workers` all confirmed `online` after restart
- **Web Deploy Sync (admin Polaris pages)**:
  - Admin Polaris migration bundle (commit `fcfdb17`) is deployed on server
  - PM2 status confirms `web` online (with `api` and `workers` also online) after deployment verification
- **Product Enrichment Assessment**: Verified and tested the product data enrichment process (LLM enrichment, worker flow, API endpoints). Best practices are followed (error handling, chunking, OpenAI usage limits). Added missing unit tests for `enrichProduct.ts`.
- **BFS Gap Closure**:
  - **G1**: `verify-session` now returns Supabase magic link for auto-login.
  - **G2**: `DashboardLayout` switches between side-nav (standalone) and `s-app-nav` (embedded).
  - **G3**: `ShopifySaveBar` implemented on Settings pages.
  - **G4**: `InlineError` replaces toasts on Settings pages (BFS requirement).
  - **G5**: `PlanGatedFeature` visually disables locked add-ons.

## Active Tasks (current)
- [x] Remove merchant API key dependency from active app/runtime paths
- [x] Add internal-secret auth for worker/eval/debug flows
- [x] Ingest Maruderm HU test products (10) and generate chunks
- [x] Fix false `RAG not ready` state in Products dashboard
- [ ] Re-run product-scoped multilingual cosmetics evals and tune results
- [ ] Align prod DB migrations for `product_facts` / chunk metadata

## Known Issues / Notes
- **Eval quality is currently sensitive to product scoping**: passing too many products at once (e.g. 10) degrades grounding and can inflate hallucination/wrong-product rates.
- **Prod schema drift observed**: `product_facts` query checks showed column mismatch (`extraction_status` missing in prod), so latest migrations should be verified/applied before relying on facts-first metrics.
- **Dev Store Testing**: Shopify embedded/dev-store verification still requires manual user testing.
- **Multi-lang RAG (Option A) additive scaffold added (feature-flagged)**:
  - Added `019_multi_lang_rag_additive.sql` (new `shop_settings`, `product_i18n`, `product_embeddings`, lang-filtered vector RPC)
  - Added server-side services for translation, multi-lang embeddings, vector search, shadow write, and `/api/answer` feature-flagged flow
  - Integrated shadow write hook into product scrape / embedding generation routes (no-op unless `MULTI_LANG_RAG_SHADOW_WRITE=true`)
  - Added `/api/answer` legacy-compatible route with shadow-read + gradual enable via `shop_settings.multi_lang_rag_enabled`
- **Multi-lang RAG (Option A) completion pass**:
  - Added merchant API endpoints for shop-level multi-lang RAG settings (`/api/merchants/me/multi-lang-rag-settings`)
  - Added Settings UI controls for `default_source_lang`, `enabled_langs`, and per-shop `multi_lang_rag_enabled`
  - Extended shadow-write coverage to product create/update and product instruction save routes
  - Shadow-write snapshot now incorporates `product_instructions` fields (`usage_instructions`, `recipe_summary`, `prevention_tips`)
  - `/api/answer` live price/stock questions now attempt Shopify Admin GraphQL live fetch using existing Shopify integration credentials (with timestamped fallback if no match/integration)
  - API/web typecheck and multi-lang RAG unit tests pass after changes
- **Super Admin AI Model Selection (global runtime)**:
  - Added additive migration `020_platform_ai_settings.sql` for DB-backed global default LLM selection
  - Added `GET/PUT /api/admin/ai-settings` (super admin only)
  - Added "Global AI Model" card in `/admin/system` to select and save runtime default LLM
  - Added runtime resolver (`platform_ai_settings` -> env fallback) and wired major AI paths (`aiAgent`, `/api/answer`, multi-lang answer/translation, enrichProduct, upsell, test RAG AI endpoint)
  - Migration not yet applied => system gracefully falls back to env `LLM_MODEL` / `gpt-4o-mini`
- **Super Admin Conversation Memory Controls**:
  - Added additive migration `021_platform_ai_settings_memory_controls.sql` (`conversation_memory_mode`, `conversation_memory_count`)
  - `/api/admin/ai-settings` now supports `conversation_memory_mode` (`last_n` / `full`) and `conversation_memory_count`
  - `/admin/system` AI settings card now includes conversation memory mode + count controls
  - Customer chatbot (`aiAgent`) and test RAG AI chat path now use runtime memory settings (full history or configurable last-N)
- **AI Cost / Token Tracking (super admin visibility, phase 1)**:
  - Added additive migration `022_ai_usage_events.sql` to store per-merchant AI usage events (model, tokens, estimated USD cost)
  - Added `trackAiUsageEvent()` helper with static OpenAI pricing map and cost estimation
  - Wired tracking into major merchant-facing AI chat flows (`aiAgent`, `/api/answer`, multi-lang `/api/answer`) and RAG embedding generation (`knowledgeBase`)
  - `/api/admin/merchants` now aggregates month-to-date AI tokens/cost per merchant and top model
  - `/admin/merchants` list now shows MTD AI tokens, estimated cost, and top model badge
  - Migration not yet applied => admin list gracefully shows zero AI usage (no runtime break)
- **AI Cost / Token Tracking (phase 2 + phase 3)**:
  - Added tracking for multi-lang translations and product enrichment LLM calls (merchant-scoped usage events)
  - `/api/admin/merchants` now supports AI usage window filter (`mtd`, `30d`, `7d`)
  - Admin merchants list can switch AI usage window and shows compact `by_model` + `by_feature` breakdown snippets
- **Admin Merchants AI Usage UI/UX fix (overlap + drill-down)**:
  - Added `GET /api/admin/merchants/:id/ai-usage?ai_window=...` detail endpoint (summary + recent events, super admin only)
  - `/admin/merchants` now avoids table crowding by keeping row AI cell compact and moving detailed breakdowns into an `AI Usage Details` modal
  - Added mobile-first merchant card layout for `/admin/merchants`; desktop keeps Polaris `IndexTable`
  - AI usage window toolbar and row actions were adjusted for responsive wrapping to prevent overlap
- **Products page responsive overlap fix (`/dashboard/products`)**:
  - Desktop list (`IndexTable`) now uses horizontal scroll + minimum table width to prevent cell overlap under dense columns
  - Product actions/status/name cells were tightened (wrap/truncate/min-width) to avoid text/button collisions
  - Header actions, saved views toolbar, filter controls, and bulk action bar were reflowed for better desktop/tablet spacing
  - Follow-up desktop polish increased table min-width and compacted status rendering in list rows to prevent `RAG Status`/`Edit` collisions on medium-width laptops
  - Filter card desktop layout was simplified (search on its own row; status/sort grouped in a right-aligned row) to prevent Polaris input overlap on wide screens
  - Filter controls were reengineered into a fixed-column, Polaris-style toolbar block (search + status + sort) for cleaner desktop alignment and spacing
- **Conversation Memory Behavior (current)**:
  - Customer conversation history is used in AI responses, but prompt context includes only the most recent 10 messages (`aiAgent` and test RAG chat path)
  - This means the system "remembers" recent dialog turns, but not unlimited full-history memory inside a single model call
